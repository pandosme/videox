# =============================================================================
# VideoX VMS - Production Docker Compose
# =============================================================================
# Simple production deployment - just edit the values below and run:
#   docker-compose up -d
#
# MongoDB is internal only (not exposed) - no authentication needed
# =============================================================================

services:
  # MongoDB Database (internal only - not exposed to host)
  mongodb:
    image: mongo:7
    container_name: videox-mongodb
    restart: unless-stopped
    networks:
      - videox-network
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # VideoX VMS Application
  videox:
    image: pandosme/videox:latest
    container_name: videox
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - videox-network
    ports:
      - "3302:3302"

    environment:
      # =======================================================================
      # REQUIRED: Change these values for your deployment
      # =======================================================================

      # Admin credentials for VideoX web interface
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: change_this_password

      # Security keys - MUST be changed in production!
      # Generate SESSION_SECRET (32+ chars): node -e "console.log(require('crypto').randomBytes(32).toString('base64').slice(0,32))"
      # Generate ENCRYPTION_KEY (32 chars): node -e "console.log(require('crypto').randomBytes(32).toString('base64').slice(0,32))"
      SESSION_SECRET: AZBTk8yzaAL1RtCazbLda8I1uHifbJtv
      ENCRYPTION_KEY: GvOzscDFhRaXAOo2OgpbASRM3YZM80ly

      # =======================================================================
      # OPTIONAL: Customize these if needed
      # =======================================================================

      # MongoDB connection (internal Docker network - use service name)
      MONGODB_URI: mongodb://mongodb:27017/videox

      # Server configuration
      NODE_ENV: development
      API_PORT: 3302
      LOG_LEVEL: info

      # Storage paths (inside container)
      STORAGE_PATH: /var/lib/videox-storage
      LOG_PATH: /var/lib/videox-storage/logs

      # Recording retention (days)
      GLOBAL_RETENTION_DAYS: 30

      # Cleanup schedule (cron format: minute hour day month weekday)
      # Default: Every 6 hours
      CLEANUP_SCHEDULE: "0 */6 * * *"

      # Performance limits
      MAX_CONCURRENT_STREAMS: 20
      MAX_CONCURRENT_EXPORTS: 3

    volumes:
      # Storage for recordings, HLS streams, and logs
      # Change the path on the left side to your desired storage location
      # Examples:
      #   - /mnt/storage/videox:/var/lib/videox-storage
      #   - /data/videox:/var/lib/videox-storage
      - ./videox-storage:/var/lib/videox-storage

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3302/api/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local

networks:
  videox-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
